#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º FactChecker
"""

import sys
import os
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

from lysobacter_rag.rag_pipeline.enhanced_rag import EnhancedRAGPipeline

def test_fixed_system():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É —Å FactChecker"""
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º FactChecker")
    print("=" * 70)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É
    rag_system = EnhancedRAGPipeline(use_notebooklm_style=True)
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ –ø—Ä–æ–±–ª–µ–º–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
    query = "–ö–∞–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —à—Ç–∞–º–º–∞ Lysobacter capsici YC5194?"
    
    print(f"üìù –ó–∞–ø—Ä–æ—Å: {query}")
    print()
    
    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
    result = rag_system.ask_question(query, top_k=8, use_notebooklm_style=True)
    
    print("üìÑ –û–¢–í–ï–¢ –° –ü–†–û–í–ï–†–ö–û–ô –§–ê–ö–¢–û–í:")
    print("=" * 50)
    print(result.answer)
    
    print("\nüìä –ú–ï–¢–ê–î–ê–ù–ù–´–ï:")
    print("=" * 30)
    print(f"üéØ –¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞: {result.query_type}")
    print(f"üìö –ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤: {result.num_sources_used}")
    print(f"üìè –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: {len(result.answer)} —Å–∏–º–≤–æ–ª–æ–≤")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
    if "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–æ–≤:" in result.answer:
        print("\n‚úÖ FactChecker –∞–∫—Ç–∏–≤–µ–Ω - –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è!")
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–µ–∫—Ü–∏—é –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
        warning_section = result.answer.split("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–æ–≤:")[1]
        print("\n‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø:")
        print(warning_section)
    else:
        print("\n‚ùå FactChecker –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç")
    
    return "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–æ–≤:" in result.answer

def compare_before_after():
    """–°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–æ –∏ –ø–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ FactChecker"""
    
    print("\nüîÑ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –î–û –∏ –ü–û–°–õ–ï –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ FactChecker")
    print("=" * 50)
    
    expected_problems = [
        "15-42¬∞C (–≤–º–µ—Å—Ç–æ 15-37¬∞C)",
        "–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–∏",
        "–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ –∫–ª–µ—Ç–æ–∫"
    ]
    
    print("üìã –û–∂–∏–¥–∞–µ–º—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ –æ—Ç–≤–µ—Ç–∞—Ö:")
    for problem in expected_problems:
        print(f"   - {problem}")
    
    print("\nüí° –ü–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ FactChecker —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞:")
    print("   ‚úÖ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—Ç—å –æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ 15-42¬∞C")
    print("   ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–≤–æ–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤")
    print("   ‚úÖ –ü–æ–≤—ã—à–∞—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å –Ω–∞—É—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö")

if __name__ == "__main__":
    print("üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ FactChecker –≤ RAG —Å–∏—Å—Ç–µ–º—É")
    print("=" * 70)
    
    # –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ—Å—Ç
    fact_checker_active = test_fixed_system()
    
    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
    compare_before_after()
    
    if fact_checker_active:
        print("\nüéâ –£–°–ü–ï–•! FactChecker –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!")
        print("\nüí° –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å:")
        print("- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")
        print("- ‚úÖ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç –æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç—è—Ö") 
        print("- ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–≤–æ–∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤")
        print("- ‚úÖ –ü–æ–≤—ã—à–∞–µ—Ç –Ω–∞—É—á–Ω—É—é –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å")
    else:
        print("\n‚ùå FactChecker –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω - —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞")
        sys.exit(1) 