# Технический контекст - Lysobacter RAG System

## Технологический стек

### Основные технологии
- **Python 3.9+** - основной язык разработки
- **ChromaDB** - векторная база данных для хранения эмбеддингов
- **sentence-transformers** - создание многоязычных эмбеддингов
- **OpenRouter API** - доступ к множеству LLM моделей
- **Streamlit** - веб-интерфейс
- **loguru** - структурированное логирование

### PDF обработка
- **PyMuPDF4LLM** - основное извлечение текста из PDF
- **pdfplumber** - специализированное извлечение таблиц
- **tabula-py** - дополнительное извлечение табличных данных
- **python-magic** - определение типов файлов

### Машинное обучение
- **sentence-transformers** - модель: `paraphrase-multilingual-MiniLM-L12-v2`
- **OpenAI API совместимость** - через OpenRouter
- **torch** - бэкенд для трансформеров

## Архитектура развертывания

### Структура проекта
```
lysobacters/
├── src/lysobacter_rag/          # Основной код
├── data/                        # PDF документы (88 файлов)
├── storage/chroma_db/           # Векторная база данных
├── logs/                        # Логи системы
├── examples/                    # Примеры и демо
├── tests/                       # Тесты системы
├── scripts/                     # Скрипты запуска
└── lysobacter_rag_env/          # Виртуальное окружение
```

### Конфигурация системы
```python
# config.py - централизованная конфигурация
EMBEDDING_MODEL = "paraphrase-multilingual-MiniLM-L12-v2"
CHROMA_COLLECTION_NAME = "lysobacter_knowledge_base"
RAG_TOP_K = 10
RAG_TEMPERATURE = 0.1
CHUNK_SIZE = 400
CHUNK_OVERLAP = 50
```

### Переменные окружения
```bash
# Основные API ключи
OPENROUTER_API_KEY=your_key_here
OPENROUTER_MODEL=google/gemini-2.5-flash-preview-05-20

# Альтернативная конфигурация
OPENAI_API_KEY=your_key_here  # для обратной совместимости
```

## Модели и алгоритмы

### Поддерживаемые LLM модели
1. **Google Gemini 2.5 Flash Preview** - рекомендуемая основная модель
2. **DeepSeek R1 Qwen3 8B** - экономичная модель с возможностями рассуждений
3. **DeepSeek Chat** - быстрая базовая модель
4. **DeepSeek V3 Base** - сбалансированная модель
5. **Google Gemini 2.0 Flash** - экспериментальная модель

### Алгоритм векторного поиска
- **Модель эмбеддингов**: Многоязычная MiniLM-L12-v2
- **Метрика расстояния**: Косинусное сходство
- **Индексация**: ChromaDB с персистентным хранением
- **Размерность векторов**: 384

### Алгоритм чанкинга
```python
class ScientificChunker:
    def chunk_extracted_elements(self, elements):
        # 1. Группировка связанных элементов
        # 2. Сохранение границ таблиц
        # 3. Оптимальное разбиение текста
        # 4. Создание метаданных
```

## Производительность и масштабирование

### Текущие метрики
- **Размер базы**: 8042 чанка, 88 PDF файлов
- **Время индексации**: ~2 часа для полной коллекции
- **Время поиска**: <1 секунда
- **Время генерации ответа**: 2-5 секунд
- **Размер хранилища**: ~2GB для ChromaDB

### Ограничения производительности
- **Максимальный размер PDF**: Ограничен памятью (тестировано до 8MB)
- **Параллельная обработка**: Батчи по 10 чанков для индексации
- **Контекстное окно**: Ограничено возможностями LLM (обычно 4k-8k токенов)

### Оптимизации
- **Батчевая обработка** для индексации
- **Дедупликация** чанков по hash
- **Ленивая загрузка** модели эмбеддингов
- **Персистентное хранение** векторов

## Развертывание и запуск

### Системные требования
- **ОС**: Linux (тестировано на Ubuntu 20.04+)
- **Python**: 3.9+
- **RAM**: Минимум 4GB, рекомендуется 8GB+
- **Диск**: 5GB свободного места
- **CUDA**: Опционально для ускорения

### Процесс установки
```bash
# Создание виртуального окружения
python3 -m venv lysobacter_rag_env
source lysobacter_rag_env/bin/activate

# Установка зависимостей
pip install -r requirements.txt

# Настройка API ключей
cp .env.example .env
# Редактирование .env файла
```

### Команды управления
```bash
# Основные команды через Makefile
make web          # Запуск веб-интерфейса
make chat         # Консольный интерфейс
make index        # Создание индекса
make rebuild      # Пересоздание индекса
make test-enhanced # Быстрое тестирование

# Переключение моделей
make switch-gemini     # Gemini 2.5 Flash
make switch-r1-qwen3   # DeepSeek R1 Qwen3
make switch-chat       # DeepSeek Chat
```

## Мониторинг и логирование

### Система логирования
```python
# loguru конфигурация
logger.add("logs/lysobacter_rag.log", 
          rotation="1 day", 
          level="INFO",
          format="{time} | {level} | {module}:{function}:{line} - {message}")
```

### Ключевые метрики для мониторинга
- **Время ответа системы**
- **Релевантность результатов поиска**
- **Успешность обработки PDF**
- **Использование памяти**
- **Частота запросов**

### Обработка ошибок
- **Graceful degradation** при сбоях API
- **Fallback механизмы** для извлечения PDF
- **Валидация данных** на всех этапах
- **Детальные сообщения об ошибках**

## Безопасность

### API безопасность
- **API ключи** хранятся в переменных окружения
- **Ограничение запросов** через OpenRouter
- **Валидация входных данных**

### Обработка файлов
- **Проверка типов файлов** через python-magic
- **Ограничение размеров** загружаемых файлов
- **Изоляция обработки** в отдельных процессах

## Интеграция и расширяемость

### API интеграция
```python
# Программный доступ к системе
from lysobacter_rag import RAGPipeline

pipeline = RAGPipeline()
result = pipeline.ask_question("Ваш вопрос")
```

### Расширение функциональности
- **Плагинная архитектура** для новых экстракторов PDF
- **Настраиваемые промпты** для разных типов вопросов
- **Интеграция с внешними API** через единый интерфейс

### Возможности кастомизации
- **Конфигурируемые паттерны** поиска таблиц
- **Настраиваемые размеры чанков**
- **Выбор модели эмбеддингов**
- **Кастомные промпты** для LLM 